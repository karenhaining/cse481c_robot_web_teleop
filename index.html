<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />

<style>
  ul li { margin-bottom: 20px; list-style: none; }
  #camera { display: none; }
  #buttons { display: none; position: relative; left: 250px; top:-100px; }
  img#cameraImage { transform: rotate(90deg); position: relative; left: -80px; top: 100px;}
</style>

<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/hello-vinitha/roslibjs@ros2actionclient/build/roslib.min.js"></script>
<script type="text/javascript" type="text/javascript">
  // Connection to rocky
  let ros = new ROSLIB.Ros({
    url: 'ws://rocky.hcrlab.cs.washington.edu:9090'
  });

  // Holding place for the FollowJointTrajectory client
  let trajectoryClient;
  let poseModeClient;
  let trajectoryModeClient;
  let positionClient;

  const ROWLENGTH = 0.0244;
  const ROWONE = 0.427;
  const TABLETOP = 0.777;
  const COLUMNLENGTH = 0.023
  // Create subscription to the camera video topic
  const subscribeToCameraVideo = () => {
    let cameraImage = document.getElementById("cameraImage");
    let topic = new ROSLIB.Topic({
        ros: ros,
        name: "/camera/color/image_raw/compressed",//"/camera/color/image_raw/compressed",
        messageType: "sensor_msgs/CompressedImage",
    });
    topic.subscribe((message) => {
      cameraImage.src = "data:image/jpg;base64," + message.data;
    });
  };

  // Create a handle to the FollowJointTrajectory action
  const createTrajectoryClient = () => {
    trajectoryClient = new ROSLIB.ActionHandle({
      ros: ros,
      name: "/stretch_controller/follow_joint_trajectory",
      actionType: "control_msgs/action/FollowJointTrajectory",
    });
  };

  const createTrajectoryModeClient = () => {
    trajectoryModeClient = new ROSLIB.Service({
      ros: ros,
      name : '/switch_to_trajectory_mode',
      serviceType : 'std_srvs/srv/Trigger'
    })
  };
  const createPositionModeClient = () => {
    poseModeClient = new ROSLIB.Service({
      ros: ros,
      name : '/switch_to_position_mode',
      serviceType : 'std_srvs/srv/Trigger'
    })
  };

  const createPositionClient = () => {
    poseModeClient = new ROSLIB.Service({
      ros: ros,
      name : '/get_joint_states',
      serviceType : 'std_srvs/srv/Trigger'
    })
  };

  const switchToPosition = () => {
    let request = new ROSLIB.ServiceRequest({})

    poseModeClient.callService(request, function(result) {});
  };

  const switchToTrajectory = () => {
    let request = new ROSLIB.ServiceRequest({});

    trajectoryModeClient.callService(request, function(result) {});
  };

  const getPositions = () => {
    let request = new ROSLIB.ServiceRequest({});

    let pos = positionClient.callService(request, function(result) {return result});
    return pos;
  };

  // Execute a FollowJointTrajectory action for given joints
  // See valid joints here: https://github.com/hello-robot/stretch_web_teleop/blob/master/src/shared/util.tsx#L4-L20
  // and joint limits here: https://github.com/hello-robot/stretch_web_teleop/blob/master/src/shared/util.tsx#L304
  const executeFollowJointTrajectory = (jointNames, jointPositions) => {
    let goal = new ROSLIB.ActionGoal({
      trajectory: {
        header: { stamp: { secs: 0, nsecs: 0 } },
        joint_names: jointNames,
        points: [
          {
            positions: jointPositions,
            time_from_start: { secs: 1, nsecs: 0 },
          },
        ],
      },
    });
    trajectoryClient.createClient(goal);
  };

  

  const pickupTile = () => {
    let goal = new ROSLIB.ActionGoal({
      trajectory: {
        header: { stamp: { secs: 0, nsecs: 0 } },
        joint_names: ['gripper_aperture', 'joint_lift'],
        points: [
        {
            positions: [0.075, TABLETOP-0.02],
            time_from_start: { secs: 1, nsecs: 0 },
          },
          {
            positions: [0.025, TABLETOP-0.02],
            time_from_start: { secs: 4, nsecs: 0 },
          },
          {
            positions: [0.025, TABLETOP+0.15
            ],
            time_from_start: { secs: 7, nsecs: 0 },
          },
        ],
      },
    });
    trajectoryClient.createClient(goal);
  };

  const pickupTileFromHolder = () => {
    let goal = new ROSLIB.ActionGoal({
      trajectory: {
        header: { stamp: { secs: 0, nsecs: 0 } },
        joint_names: ['gripper_aperture', 'joint_lift'],
        points: [
        {
            positions: [0.075, TABLETOP+0.106],
            time_from_start: { secs: 1, nsecs: 0 },
          },
          {
            positions: [0.025, TABLETOP+0.106],
            time_from_start: { secs: 4, nsecs: 0 },
          },
          {
            positions: [0.025, TABLETOP+0.175
            ],
            time_from_start: { secs: 7, nsecs: 0 },
          },
        ],
      },
    });
    trajectoryClient.createClient(goal);
  };

  const dropTile = () => {
    let goal = new ROSLIB.ActionGoal({
      trajectory: {
        header: { stamp: { secs: 0, nsecs: 0 } },
        joint_names: ['gripper_aperture', 'joint_lift'],
        points: [
        {
            positions: [0.025 , TABLETOP-0.02],
            time_from_start: { secs: 1, nsecs: 0 },
          },
          {
            positions: [0.025, TABLETOP-0.02],
            time_from_start: { secs: 4, nsecs: 0 },
          },
          {
            positions: [0.025, TABLETOP-0.02],
            time_from_start: { secs: 7, nsecs: 0 },
          },
          {
            positions: [0.075, TABLETOP + 0.15],
            time_from_start: { secs: 9, nsecs: 0 },
          },
        ],
      },
    });
    trajectoryClient.createClient(goal);
  };

  // Open the gripper using FollowJointTrajectory
  const openGripper = () => {
    executeFollowJointTrajectory(['gripper_aperture'], [0.04])
  };

  // Close the gripper using FollowJointTrajectory
  const closeGripper = () => {
    executeFollowJointTrajectory(['gripper_aperture'], [0.02])
  };

  const rotateCounterclockwise = () => {
    executeFollowJointTrajectory(['joint_wrist_roll'], [-1.75])
  };

  const rotateClockwise = () => {
    executeFollowJointTrajectory(['joint_wrist_roll'], [1.75])
  };

  const levelGrippper = () => {
    executeFollowJointTrajectory(['joint_wrist_roll'], [0])
  };

  const levelPitch = () => {
    executeFollowJointTrajectory(['joint_wrist_pitch'], [0])
  };

  const pitchFortyFive = () => {
    executeFollowJointTrajectory(['joint_wrist_pitch'], [-0.58])
  };

  const pitchDownForDropFromHolder = () => {
    executeFollowJointTrajectory(['joint_wrist_pitch'], [-1.3]);
  }

  const moveArmToHolder = () => {
    executeFollowJointTrajectory(['wrist_extension'], [ROWONE-10.555 *ROWLENGTH]);
  }

  // Move the lift using FollowJointTrajectory
  const moveLiftToTop = () => {
    executeFollowJointTrajectory(['joint_lift'], [1.1]);
  };

  // Move the lift using FollowJointTrajectory
  const moveLiftToTableTop = () => {
    executeFollowJointTrajectory(['joint_lift'], [TABLETOP]);
  };

  const moveLiftToSlightlyAboveTableTop = () => {
    executeFollowJointTrajectory(['joint_lift'], [TABLETOP + 0.02]);
  };

  const moveLiftToSlightlyAboveTableTopWhilePitchedForHolderPickup = () => {
    executeFollowJointTrajectory(['joint_lift'], [TABLETOP + 0.108]);
  };

  const moveCamera = () => {
    let goal = new ROSLIB.ActionGoal({
      trajectory: {
        header: { stamp: { secs: 0, nsecs: 0 } },
        joint_names: ['joint_head_tilt', 'joint_head_pan'],
        points: [
        {
            positions: [-0.7 , -1.3],
            time_from_start: { secs: 1, nsecs: 0 },
          },
        ],
      },
    });
    trajectoryClient.createClient(goal);
  }

  // Move base forward
  const moveBaseForward = () => {
    executeFollowJointTrajectory(['translate_mobile_base'], [0.1]);
  };

  const moveBaseForwardOneTile = () => {
    executeFollowJointTrajectory(['translate_mobile_base'], [COLUMNLENGTH]);
  };

  const moveBaseBackwardOneTile = () => {
    executeFollowJointTrajectory(['translate_mobile_base'], [-1 * COLUMNLENGTH]);
  };

  const moveBaseBackwardMislaigned = () => {
    executeFollowJointTrajectory(['translate_mobile_base'], [-0.025]);
  }

  const moveArmBackwardOneTile = () => {
    //let p = getPositions();
    //console.log(p);

    executeFollowJointTrajectory(['wrist_extension'], [0.1]);
  };

  const moveArmForwardOneTile = () => {

    executeFollowJointTrajectory(['wrist_extension'], [0.32]);
  };

  // Move base backward
  const moveBaseBackward = () => {
    executeFollowJointTrajectory(['translate_mobile_base'], [-0.1]);
  };

  const rotateHeadClockwiseNinety = () => {
    executeFollowJointTrajectory(['joint_head_pan'], [-1.45]);
  };
  const rotateHeadDown = () => {
    executeFollowJointTrajectory(['joint_head_tilt'], [-0.55]);
  };

  const moveArm1 = () => {
    executeFollowJointTrajectory(['wrist_extension'], [ROWONE]);
  }

  const moveArm2 = () => {
    executeFollowJointTrajectory(['wrist_extension'], [ROWONE - ROWLENGTH]);
  }

  const moveArm3 = () => {
    executeFollowJointTrajectory(['wrist_extension'], [ROWONE - 2 * ROWLENGTH]);
  }

  const moveArm4 = () => {
    executeFollowJointTrajectory(['wrist_extension'], [ROWONE - 3 * ROWLENGTH]);
  }

  const moveArm5 = () => {
    executeFollowJointTrajectory(['wrist_extension'], [ROWONE - 4 * ROWLENGTH]);
  }

  const moveArm6 = () => {
    executeFollowJointTrajectory(['wrist_extension'], [ROWONE - 5 * ROWLENGTH]);
  }

  const moveArm7 = () => {
    executeFollowJointTrajectory(['wrist_extension'], [ROWONE - 6 * ROWLENGTH]);
  }

  const moveArm8 = () => {
    executeFollowJointTrajectory(['wrist_extension'], [ROWONE - 7 * ROWLENGTH]);
  }

  const moveArm9 = () => {
    executeFollowJointTrajectory(['wrist_extension'], [ROWONE - 8 * ROWLENGTH]);
  }

  const moveArm10 = () => {
    executeFollowJointTrajectory(['wrist_extension'], [ROWONE - 9 * ROWLENGTH]);
  }

  const moveArm11 = () => {
    executeFollowJointTrajectory(['wrist_extension'], [ROWONE - 10 * ROWLENGTH]);
  }

  const moveArm12 = () => {
    executeFollowJointTrajectory(['wrist_extension'], [ROWONE - 11 * ROWLENGTH]);
  }

  const moveArm13 = () => {
    executeFollowJointTrajectory(['wrist_extension'], [ROWONE - 12 * ROWLENGTH]);
  }

  const moveArm14 = () => {
    executeFollowJointTrajectory(['wrist_extension'], [ROWONE - 13 * ROWLENGTH]);
  }

  const moveArm15 = () => {
    executeFollowJointTrajectory(['wrist_extension'], [ROWONE - 14 * ROWLENGTH]);
  }

  // Called when the rosbridge websocket connection is successful
  ros.on('connection', function() {
    document.getElementById('connection').innerHTML = "Connected to Stretch.";
    document.getElementById('camera').style.display = "block";
    document.getElementById('buttons').style.display = "block";
    console.log('Connected to websocket server.');
  
    subscribeToCameraVideo();
    createTrajectoryClient();
    createPositionModeClient();
    createTrajectoryModeClient();
    createPositionClient();
  });

  // Called when the rosbridge websocket connection is failed
  ros.on('error', function(error) {
    document.getElementById('connection').innerHTML = "Error connecting to Stretch (see console for details)";
    console.log('Error connecting to websocket server: ', error);
  });

  // Called when the rosbridge websocket connection is closed
  ros.on('close', function() {
    document.getElementById('connection').innerHTML = "Disconnected";
    document.getElementById('camera').style.display = "none";
    document.getElementById('connection').style.display = "none";
    console.log('Connection to websocket server closed.');
  });
</script>

<body>
  <h1>Scrabble Bot Interface v. 0.1</h1>
  <p id="connection">Connecting...</p>
  <div id="camera"><img id="cameraImage" /></div>
  <div id="buttons">
    <ul>
        <li><button onClick="openGripper()">Open gripper</button></li>
        <li><button onClick="closeGripper()">Close gripper</button></li>
        <li><button onClick="rotateClockwise()">Rotate gripper clockwise</button></li>
        <li><button onClick="rotateCounterclockwise()">Rotate gripper counterclockwise</button></li>
        <li><button onClick="levelGrippper()">Level gripper</button></li>
       <li><button onClick="levelPitch()">Flatten Pitch</button></li>
       <li><button onClick="pitchFortyFive()">Pitch down for holder pickup</button></li>
       <li><button onClick="pitchDownForDropFromHolder()">Pitch down for drop from holder</button></li>
      <li><button onClick="pickupTile()">Pickup Tile</button></li>
      <li><button onClick="pickupTileFromHolder()">Pickup Tile From Holder</button></li>
      <li><button onClick="dropTile()"> Drop tile</button></li>
      <li><button onClick="rotateHeadClockwiseNinety()">Rotate head clockwise</button></li>
      <li><button onClick="rotateHeadDown()">Look down</button></li>
        <li><button onClick="moveLiftToTop()">Move lift to top</button></li>
        <li><button onClick="moveLiftToTableTop()">Move lift to tabletop</button></li>
        <li><button onClick="moveLiftToSlightlyAboveTableTop()">Move Lift slightly above tabletop</button></li>
        <li><button onClick="moveLiftToSlightlyAboveTableTopWhilePitchedForHolderPickup()">Move Lift to Slightly above tabletop while pitched for holder pickup</button></li>
        <li><button onClick="moveBaseForwardOneTile()">Move base forward one tile</li>
          <li><button onClick="moveBaseBackwardOneTile()">Move base backward one tile</li>
            <li><button onClick="moveBaseBackwardMisaligned()">Move base backward a tiny misaligned bit</button></li>
            <li><button onClick="moveArmToHolder()">Move Arm To Holder</button></li>
    </ul>
    
  </div>
  <div id="armbuttons"> <ul> <li> <button onClick="moveArm1()">Move Arm 1</button></li>
    <li> <button onClick="moveArm2()">Move Arm 2</button></li>
    <li> <button onClick="moveArm3()">Move Arm 3</button></li>
    <li> <button onClick="moveArm4()">Move Arm 4</button></li>
    <li> <button onClick="moveArm5()">Move Arm 5</button></li>
    <li> <button onClick="moveArm6()">Move Arm 6</button></li>
    <li> <button onClick="moveArm7()">Move Arm 7</button></li>
    <li> <button onClick="moveArm8()">Move Arm 8</button></li>
    <li> <button onClick="moveArm9()">Move Arm 9</button></li>
    <li> <button onClick="moveArm10()">Move Arm 10</button></li>
    <li> <button onClick="moveArm11()">Move Arm 11</button></li>
    <li> <button onClick="moveArm12()">Move Arm 12</button></li>
    <li> <button onClick="moveArm13()">Move Arm 13</button></li>
    <li> <button onClick="moveArm14()">Move Arm 14</button></li>
    <li> <button onClick="moveArm15()">Move Arm 15</button></li>

  
  
  </ul></div>
</body>
</html>
